<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cuddle Clash — Continue</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f8fafc;--text:#0f172a;--muted:#64748b;--card:#fff;--shadow:0 12px 30px rgba(2,8,23,.08);--radius:16px}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:740px;margin:32px auto;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-bottom:14px}
  h1{margin:0 0 6px;font-size:28px}
  .sub{margin:0 0 14px;color:var(--muted);font-size:14px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr;margin-top:14px}
  .btn{display:flex;align-items:center;justify-content:center;text-decoration:none;padding:14px;border-radius:12px;font-weight:700;border:1px solid #e5e7eb;box-shadow:var(--shadow);color:#111827;background:#fff}
  .primary{background:#4f46e5;color:#fff;border-color:transparent}
  .ok{background:#16a34a;color:#052e16;border-color:transparent}
  .kpi{display:grid;gap:4px;margin-top:6px}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .value{font-weight:800;font-size:22px}
  .mini{display:grid;gap:6px;margin-top:14px}
  .stat{display:flex;justify-content:space-between;color:var(--muted)}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}
  .item small{color:#64748b}
  .savewrap{margin-top:12px;border:1px dashed #d1d5db;border-radius:12px;padding:12px;background:#f9fafb}
  .savehdr{font-size:13px;color:#475569;margin:0 0 8px}
  .savegrid{display:grid;gap:10px;grid-template-columns:1fr auto}
  .input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px;background:#fff}
  .hide{display:none}
  @media (max-width:700px){.row{grid-template-columns:1fr} .savegrid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">

  <!-- Resume UI if someone lands without params -->
  <section id="resumeCard" class="card hide">
    <h2 style="margin:0 0 8px;font-size:22px">Resume your order</h2>
    <p class="sub">Paste your Order ID and (optionally) your email, or use your last order on this device.</p>

    <div id="lastOrderRow" class="row hide" style="margin:0 0 12px">
      <a id="resumeLastBtn" class="btn" href="#">⟲ Resume last order on this device</a>
    </div>

    <div style="display:grid;gap:10px">
      <input id="lookupOrder" class="input" placeholder="Order ID (e.g., Rieniets_25-09-01-001)">
      <input id="lookupEmail" class="input" placeholder="Email (optional)">
      <a id="lookupGo" class="btn primary" href="#">Go</a>
    </div>
  </section>

  <!-- Main actions -->
  <section class="card">
    <h1>Great! What’s next?</h1>
    <p class="sub">Choose an option below to continue.</p>
    <div id="orderChip" class="pill hide">Order&nbsp;<span id="orderText"></span></div>

    <div class="row">
      <a id="addBtn"  class="btn primary" href="#">＋ Add a stuffy</a>
      <a id="doneBtn" class="btn ok"      href="#">✅ I’m done — review my order</a>
    </div>

    <!-- Single “save this link” row -->
    <div id="saveRow" class="savewrap hide">
      <p class="savehdr">Need to take a break? Save this link to continue later where you left off:</p>
      <div class="savegrid">
        <input id="resumeUrl" class="input" readonly>
        <a id="copyLink" class="btn" href="#">📋 Copy</a>
      </div>
    </div>

    <p id="syncNote" class="sub hide">Syncing your latest submission… this can take a moment.</p>
  </section>

  <!-- Counts -->
  <section id="statsCard" class="card hide">
    <div class="kpi"><div class="label">Order email</div><div id="kpiEmail" class="value">—</div></div>
    <div class="kpi"><div class="label">Added so far</div><div id="kpiTotal" class="value">—</div></div>

    <div class="mini">
      <h3 style="margin:8px 0 2px">Stages (current / target)</h3>
      <div class="stat"><span>Basic</span><span id="sBasic">—</span></div>
      <div class="stat"><span>EV1</span><span id="sEV1">—</span></div>
      <div class="stat"><span>EV2</span><span id="sEV2">—</span></div>
    </div>

    <div class="mini">
      <h3 style="margin:8px 0 2px">Types (current / target)</h3>
      <div class="stat"><span>Magic</span><span id="tMagic">—</span></div>
      <div class="stat"><span>Beast</span><span id="tBeast">—</span></div>
      <div class="stat"><span>Earth</span><span id="tEarth">—</span></div>
      <div class="stat"><span>Sky</span><span id="tSky">—</span></div>
      <div class="stat"><span>Water</span><span id="tWater">—</span></div>
    </div>
  </section>

  <!-- List of items -->
  <section id="listCard" class="card hide">
    <h3 style="margin:8px 0 12px">Your submissions</h3>
    <div id="itemsList" class="list"></div>
  </section>
</div>

<script>
  /* ====== EDIT THESE ====== */
  const FORM_B_URL = "https://tally.so/r/w8XMZx";   // Add a stuffy
  const FORM_C_URL = "https://tally.so/r/mVKxrg";   // I'm done
  const GAS_API    = "https://script.google.com/macros/s/AKfycbzI9Vs_eAy1ESqfCdeRGHS_FkLCf6bgB7YNhy8y6hI/exec"; // Apps Script /exec
  const TARGETS    = { total:40, stages:{Basic:24, EV1:10, EV2:6}, types:{Magic:8, Beast:8, Earth:8, Sky:8, Water:8} };
  /* ======================== */

  const qp = new URLSearchParams(location.search);
  const orderId = qp.get("order_id") || "";
  const email   = qp.get("email") || "";
  const just    = qp.get("just") === "1";

  // Elements
  const addBtn   = document.getElementById("addBtn");
  const doneBtn  = document.getElementById("doneBtn");
  const syncNote = document.getElementById("syncNote");
  const chip     = document.getElementById("orderChip");
  const orderTxt = document.getElementById("orderText");
  const stats    = document.getElementById("statsCard");
  const kpiTotal = document.getElementById("kpiTotal");
  const kpiEmail = document.getElementById("kpiEmail");
  const resumeCard   = document.getElementById("resumeCard");
  const lastOrderRow = document.getElementById("lastOrderRow");
  const resumeLastBtn= document.getElementById("resumeLastBtn");
  const lookupOrder  = document.getElementById("lookupOrder");
  const lookupEmail  = document.getElementById("lookupEmail");
  const lookupGo     = document.getElementById("lookupGo");
  const saveRow      = document.getElementById("saveRow");
  const resumeUrl    = document.getElementById("resumeUrl");
  const copyLinkBtn  = document.getElementById("copyLink");

  const LS_LAST = "cc_last_order"; // stores {orderId,email}

  function buildRouterUrl(oid, em){
    const q = new URLSearchParams({ order_id: oid || "", email: em || "" });
    return location.origin + location.pathname + "?" + q.toString();
  }
  function link(base){
    const q = new URLSearchParams({ order_id: orderId, email: email });
    return base + "?" + q.toString();
  }

  // JSONP loader (to avoid CORS)
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cc_cb_' + Math.random().toString(36).slice(2);
      const s  = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      function cleanup(){ delete window[cb]; if (s && s.parentNode) s.parentNode.removeChild(s); }
      document.head.appendChild(s);
    });
  }

  // If missing params, show resume UI
  if (!orderId || !email){
    resumeCard.classList.remove("hide");
    try{
      const saved = JSON.parse(localStorage.getItem(LS_LAST) || "null");
      if (saved && saved.orderId){
        lastOrderRow.classList.remove("hide");
        resumeLastBtn.href = buildRouterUrl(saved.orderId, saved.email || "");
      }
    }catch(_){}
    lookupGo.addEventListener("click",(e)=>{
      e.preventDefault();
      const oid = (lookupOrder.value||"").trim();
      const em  = (lookupEmail.value||"").trim();
      if (!oid){ lookupOrder.focus(); return; }
      location.href = buildRouterUrl(oid, em);
    });
  } else {
    // Normal flow
    orderTxt.textContent = orderId;
    kpiEmail.textContent = email;
    chip.classList.remove("hide");
    addBtn.href  = link(FORM_B_URL);
    doneBtn.href = link(FORM_C_URL);

    // Show and populate save link row
    const myLink = buildRouterUrl(orderId, email);
    saveRow.classList.remove("hide");
    resumeUrl.value = myLink;
    copyLinkBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      try { await navigator.clipboard.writeText(myLink); copyLinkBtn.textContent = "✅ Copied"; }
      catch {
        resumeUrl.select(); document.execCommand('copy');
        copyLinkBtn.textContent = "✅ Copied";
      }
      setTimeout(()=> copyLinkBtn.textContent = "📋 Copy", 1300);
    });

    // Remember last order locally
    try { localStorage.setItem(LS_LAST, JSON.stringify({orderId, email})); } catch(_){}

    init();
  }

  async function init(){
    const baseTotal = Number(localStorage.getItem("cc_last_total_"+orderId) || "0");
    if (just){
      syncNote.classList.remove("hide");
      const d1 = await pollForIncrease(baseTotal, 8); renderCounts(d1);
      const d2 = await fetchItems();                 renderItems(d2);
      syncNote.classList.add("hide");
    } else {
      const d1 = await fetchCounts(); renderCounts(d1);
      const d2 = await fetchItems();  renderItems(d2);
    }
  }

  async function fetchCounts(){
    const url = `${GAS_API}?fn=getCounts&order_id=${encodeURIComponent(orderId)}${email?`&email=${encodeURIComponent(email)}`:''}`;
    try{ return await jsonp(url); }catch{ return null; }
  }
  async function fetchItems(){
    const url = `${GAS_API}?fn=getItems&order_id=${encodeURIComponent(orderId)}${email?`&email=${encodeURIComponent(email)}`:''}`;
    try{ return await jsonp(url); }catch{ return null; }
  }
  async function pollForIncrease(baseTotal, maxTries){
    let tries=0, delay=350, latest=null;
    while(tries<maxTries){
      latest = await fetchCounts();
      const total = Number(latest?.totals?.total || 0);
      if (total > baseTotal){
        localStorage.setItem("cc_last_total_"+orderId, String(total));
        return latest;
      }
      await new Promise(r=>setTimeout(r,delay));
      delay = Math.min(2000, Math.round(delay*1.7));
      tries++;
    }
    return latest;
  }

  function renderCounts(d){
    if (!d || !d.ok) return;
    stats.classList.remove("hide");
    const t=d.totals||{}, ty=t.types||{}, st=t.stages||{};
    kpiTotal.textContent = t.total ?? "—";
    set("sBasic", fmt(st.Basic, 24));
    set("sEV1",   fmt(st.EV1,   10));
    set("sEV2",   fmt(st.EV2,    6));
    set("tMagic", fmt(ty.Magic,  8));
    set("tBeast", fmt(ty.Beast,  8));
    set("tEarth", fmt(ty.Earth,  8));
    set("tSky",   fmt(ty.Sky,    8));
    set("tWater", fmt(ty.Water,  8));
  }

  function renderItems(d){
    const listCard = document.getElementById("listCard");
    const itemsList= document.getElementById("itemsList");
    if (!listCard || !itemsList) return;
    itemsList.innerHTML = "";
    if (!d || !d.ok || !Array.isArray(d.items) || d.items.length===0){
      listCard.classList.remove("hide");
      itemsList.innerHTML = '<div class="item"><strong>No stuffies yet</strong><small>Add one to get started</small></div>';
      return;
    }
    d.items.forEach(it=>{
      const div=document.createElement('div'); div.className='item';
      const name=escapeHtml(it.name||'—');
      const stage=escapeHtml(it.stage||'—');
      const type=escapeHtml(it.type||'—');
      div.innerHTML = `<strong>${name}</strong><small>${stage} · ${type}</small>`;
      itemsList.appendChild(div);
    });
    listCard.classList.remove("hide");
  }

  function set(id,v){ const el=document.getElementById(id); if(el) el.textContent=(v==null?'—':v); }
  function fmt(cur,tgt){ const a=Number(cur||0); const b=Number(tgt||0); return `${a} / ${b}`; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
